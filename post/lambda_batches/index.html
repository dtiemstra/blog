<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta property="og:site_name" content>
<meta property="og:type" content="article">
<meta property="og:image" content="dtiemstra.github.io/blog/img/code.jpg">
<meta property="twitter:image" content="dtiemstra.github.io/blog/img/code.jpg">
<meta name=title content="Prevent valid messages from being rejected by AWS Lambda">
<meta property="og:title" content="Prevent valid messages from being rejected by AWS Lambda">
<meta property="twitter:title" content="Prevent valid messages from being rejected by AWS Lambda">
<meta name=description content="Development, Azure, .Net">
<meta property="og:description" content="Development, Azure, .Net">
<meta property="twitter:description" content="Development, Azure, .Net">
<meta property="twitter:card" content="Partial batch response is a feature of AWS Lambda that allows you to signal which messages in a batch were not processed successfully. This prevents all messages in a single batch from being rejected when an error occurs during the processing of a single message.">
<meta name=keyword content="Development, Azure, .Net">
<link rel="shortcut icon" href=/dtiemstra.github.io/blog/img/favicon.ico>
<title>Prevent valid messages from being rejected by AWS Lambda | dtiemstra.github.io</title>
<link rel=canonical href=dtiemstra.github.io/blog/post/lambda_batches/>
<link rel=stylesheet href=/dtiemstra.github.io/blog/css/bootstrap.min.css>
<link rel=stylesheet href=/dtiemstra.github.io/blog/css/hugo-theme-cleanwhite.min.css>
<link rel=stylesheet href=/dtiemstra.github.io/blog/css/zanshang.css>
<link rel=stylesheet href=/dtiemstra.github.io/blog/css/font-awesome.all.min.css>
<link rel=stylesheet href=dtiemstra.github.io/blog/css/overrides.css>
<script src=/dtiemstra.github.io/blog/js/jquery.min.js></script>
<script src=/dtiemstra.github.io/blog/js/bootstrap.min.js></script>
<script src=/dtiemstra.github.io/blog/js/hux-blog.min.js></script>
<script src=/dtiemstra.github.io/blog/js/lazysizes.min.js></script>
</head>
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
<div class=container-fluid>
<div class="navbar-header page-scroll">
<button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=/dtiemstra.github.io/blog/></a>
</div>
<div id=huxblog_navbar>
<div class=navbar-collapse>
<ul class="nav navbar-nav navbar-right">
<li>
<a href=/dtiemstra.github.io/blog/>All Posts</a>
</li>
<li>
<a href=/dtiemstra.github.io/blog/categories/tech/>tech</a>
</li>
<li>
<a href=/dtiemstra.github.io/blog/search><i class="fa fa-search"></i></a>
</li>
</ul>
</div>
</div>
</div>
</nav>
<script>var $body=document.body,$toggle=document.querySelector('.navbar-toggle'),$navbar=document.querySelector('#huxblog_navbar'),$collapse=document.querySelector('.navbar-collapse');$toggle.addEventListener('click',handleMagic);function handleMagic(a){$navbar.className.indexOf('in')>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf('in')<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script>
<style type=text/css>header.intro-header{background-image:url(/dtiemstra.github.io/blog/img/code.jpg)}</style>
<header class=intro-header>
<div class=container>
<div class=row>
<div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1">
<div class=post-heading>
</div>
</div>
</div>
</div>
</header>
<div class=container>
<div class="col-lg-8 col-lg-offset-1
col-md-10 col-md-offset-1
post-container">
<h1>Prevent valid messages from being rejected by AWS Lambda</h1>
<h2 class=subheading></h2>
<p>AWS Lambda is a powerful tool that allows developers to build scalable and efficient serverless applications. One of the key features of Lambda is its ability to process batches of messages efficiently. However, when working with batches, the default behavior is to reject all messages in the batch when processing of a single message fails. This can lead to valid messages being transferred to a Dead Letter Queue. Fortunately you can use the partial batch response to prevent this from happening.</p>
<h2 id=the-scenario>The scenario</h2>
<p>To understand partial batch response, let&rsquo;s consider an example. Suppose you have an Amazon Simple Queue Service (SQS) queue with a dead letter queue and a Lambda function that processes a batch of messages from that SQS queue. The Lambda function processes each message sequentially and performs some logic. Now, let&rsquo;s say that one of the messages in the batch fails during processing due to an error. Without partial batch response, the entire batch would be rejected, and all of the messages would end up in the configured dead letter queue.</p>
<h2 id=the-solution>The Solution</h2>
<p>The solution is to implement the partial batch response feature. With partial batch response, the Lambda function can indicate which messages in the batch were not processed successfully. The Lambda function can return a response that includes a list of message IDs for the messages that were not processed successfully. The response can be sent back to SQS, and SQS can then remove the successfully processed messages from the queue and leave the failed messages in the queue for further processing or investigation.</p>
<p>To enable this feature you must first set the <code>reportItemFailures</code> on the eventsource of the lambda</p>
<pre tabindex=0><code>#example for setting the reportBatchItemFailures using aws cdk
const myEventSource = new SqsEventSource(myQueue, {
	reportBatchItemFailures: true,
});
myLambda.addEventSource(myEventSource);
</code></pre><p>Secondly, make sure your lambda function returns a <code>SQSBatchResponse</code> object. With this object you have fine grained control on which items are rejected by your function.</p>
<pre tabindex=0><code>public async Task&lt;SQSBatchResponse&gt; ProcessMessages(SQSEvent sqsEvent)
{
	SQSBatchResponse response = new();
	foreach(var message in sqsEvent.Records)
	{
		try
		{
			//perform some logic here
		}
		catch(Exception e)
		{
			response.BatchItemFailures.Add(new SQSBatchResponse.BatchItemFailure { ItemIdentifier = message.MessageId });
		}
	}
	return response;
}
</code></pre><p>Only the messages that are marked as failed will be visible again in the queue.</p>
<p><strong>Important: If you&rsquo;re using this feature with a FIFO queue, your function should stop processing messages after the first failure and return all failed and unprocessed messages in batchItemFailures. This helps to preserve the correct order of messages in your queue.</strong></p>
<h2 id=not-limted-to-sqs>Not limted to SQS</h2>
<p>Setting the ReportItemFailures is not only limited to AWS SQS as the datasource for your Lambda function. When using Kinesis or DynamoDB Streams the ReportItemFailures can also be set. See <a href=https://docs.aws.amazon.com/lambda/latest/dg/API_CreateEventSourceMapping.html target=_blank rel=noopener>https://docs.aws.amazon.com/lambda/latest/dg/API_CreateEventSourceMapping.html</a>
for more information.</p>
<hr>
<ul class=pager>
<li class=previous>
<a href=dtiemstra.github.io/blog/post/configuring_dotnet_applications/ data-toggle=tooltip data-placement=top title="Configuring your .Net applications">&larr;
Previous Post</a>
</li>
</ul>
</div>
<div class="col-lg-3 col-lg-offset-0
col-md-3 col-md-offset-0
col-sm-12
col-xs-12
sidebar-container">
<section class="visible-md visible-lg">
<div class=short-about>
<p>A blog about .Net, Azure, software development and my personal expreriences as a software developer. Opinions are my own.</p>
<ul class=list-inline>
<li>
<a target=_blank href=https://github.com/dtiemstra>
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
<li>
<a target=_blank href=https://www.linkedn.com/in/dtiemstra>
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
<li>
<a target=_blank href=https://stackoverflow.com/users/dtiemstra>
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
</ul>
</div>
</section>
<section>
<hr class="hidden-sm hidden-xs">
<h5>FEATURED TAGS</h5>
<div class=tags>
<a href=/dtiemstra.github.io/blog/tags/.net title=.net>
.net
</a>
</div>
</section>
</div>
<footer>
<div class=container>
<div class=row>
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<ul class="list-inline text-center">
<li>
<a target=_blank href=https://github.com/dtiemstra>
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
<li>
<a target=_blank href=https://www.linkedn.com/in/dtiemstra>
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
<li>
<a target=_blank href=https://stackoverflow.com/users/dtiemstra>
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
</ul>
<p class="copyright text-muted">
Copyright &copy; 2023
<br>
<a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> by <a href=https://zhaohuabing.com>Huabing</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true"></iframe>
</p>
</div>
</div>
</div>
</footer>
<script>function loadAsync(f,b){var c=document,d='script',a=c.createElement(d),e=c.getElementsByTagName(d)[0];a.src=f,b&&a.addEventListener('load',function(a){b(null,a)},!1),e.parentNode.insertBefore(a,e)}</script>
<script>$('#tag_cloud').length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:'#bbbbee',end:'#0085a1'}},$('#tag_cloud a').tagcloud()})</script>
<script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var a=document.querySelector("nav");a&&FastClick.attach(a)})</script>
<script type=text/javascript>function generateCatalog(a){_containerSelector='div.post-container';var h=$(_containerSelector),c,d,e,f,g,b;return c=h.find('h1,h2,h3,h4,h5,h6'),$(a).html(''),c.each(function(){d=$(this).prop('tagName').toLowerCase(),g="#"+$(this).prop('id'),e=$(this).text(),b=$('<a href="'+g+'" rel="nofollow">'+e+'</a>'),f=$('<li class="'+d+'_nav"></li>').append(b),$(a).append(f)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(a){a.preventDefault(),$('.side-catalog').toggleClass("fold")}),loadAsync("/dtiemstra.github.io/blog/js/jquery.nav.js",function(){$('.catalog-body').onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script>
</body>
</html>